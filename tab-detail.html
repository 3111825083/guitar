<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>吉他谱详情 - 吉他谱网</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#E63946',
                        secondary: '#457B9D',
                        light: '#F1FAEE',
                        dark: '#1D3557',
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .btn-action {
                @apply px-4 py-2 rounded-lg transition-colors duration-300 flex items-center gap-2;
            }
            .tab-fullscreen {
                @apply fixed top-0 left-0 right-0 bottom-0 z-50 bg-white flex flex-col p-4 overflow-auto;
            }
            /* 全屏下的谱子容器：取消最大宽度限制，占满窗口 */
            .tab-fullscreen .tab-content {
                @apply w-full !max-w-none;
            }
            /* 全屏下的图片：宽度100%铺满，高度自动保持原比例 */
            .tab-fullscreen img {
                @apply w-full h-auto !max-w-none;
            }
            /* 全屏关闭按钮样式 */
            .fullscreen-close {
                @apply absolute top-4 right-4 bg-primary text-white p-2 rounded-full cursor-pointer hover:bg-red-600 z-10;
            }
        }
    </style>
</head>
<body class="bg-light text-dark min-h-screen">
    <header class="sticky top-0 bg-white shadow-sm z-50 py-4">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-primary">
                <i class="fas fa-guitar mr-2"></i>吉他谱网
            </a>

            <div class="flex gap-3">
                <button id="fullscreenBtn" class="btn-action bg-dark text-white hover:bg-gray-800">
                    <i class="fas fa-expand"></i>
                    <span class="hidden sm:inline">全屏查看</span>
                </button>
                <button id="autoScrollBtn" class="btn-action border border-primary text-primary hover:bg-primary/10" title="自动滚动">
                    <i class="fas fa-play"></i>
                    <span class="hidden sm:inline">自动滚动</span>
                </button>
                <button id="downloadBtn" class="btn-action bg-secondary text-white hover:bg-secondary/90">
                    <i class="fas fa-download"></i>
                    <span class="hidden sm:inline">下载谱子</span>
                </button>
                <button id="printBtn" class="btn-action border border-primary text-primary hover:bg-primary/10">
                    <i class="fas fa-print"></i>
                    <span class="hidden sm:inline">打印谱子</span>
                </button>
                <a href="index.html" class="btn-action bg-gray-200 hover:bg-gray-300">
                    <i class="fas fa-arrow-left"></i>
                    <span class="hidden sm:inline">返回首页</span>
                </a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h1 id="tabTitle" class="text-3xl font-bold mb-2">加载中...</h1>
            <div class="flex flex-wrap gap-4 text-gray-500 mb-4" id="tabStats">
                <span id="singerSpan"><i class="fas fa-user mr-1"></i> 加载中...</span>
                <span id="typeSpan"><i class="fas fa-guitar mr-1"></i> 加载中...</span>
                <span id="viewSpan"><i class="fas fa-eye mr-1"></i> 加载中...</span>
                <span id="downloadSpan"><i class="fas fa-download mr-1"></i> 加载中...</span>
            </div>
            <p class="text-gray-600">调式：C调 | 难度：入门 | 拍号：4/4 | 速度：80BPM</p>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-center">吉他谱正文</h2>
            <div id="tabContent" class="tab-content space-y-6">
                <div class="text-center text-gray-500" id="loadingTip">正在加载谱子图片...</div>
            </div>
        </div>

        <div>
            <h2 class="text-2xl font-bold mb-6">相关吉他谱推荐</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="relatedTabs">
                <!-- 动态生成相关谱子 -->
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="mb-2">© 2025 吉他谱网 - 免费分享吉他谱资源</p>
            <p class="text-sm text-gray-400">本站谱子仅供学习交流，禁止商用</p>
        </div>
    </footer>

    <script>
        // 全局变量：谱子配置数据
        let tabsConfig = {};
        let currentTabKey = null;
        let currentTab = null;
        // 从URL获取参数
        const urlParams = new URLSearchParams(window.location.search);
        const tabId = urlParams.get('id');
        const tabName = decodeURIComponent(urlParams.get('name') || '未知谱子');
        const tabFolder = decodeURIComponent(urlParams.get('folder') || tabName);

        // 1. 加载配置文件，获取谱子详细信息
        async function loadTabConfig() {
            try {
                const response = await fetch('tabs-config.json');
                if (!response.ok) throw new Error('配置文件加载失败');
                tabsConfig = await response.json();
                // 从配置中找到当前谱子的信息（通过ID匹配）
                currentTabKey = Object.keys(tabsConfig).find(folder => tabsConfig[folder].id === tabId);
                currentTab = currentTabKey ? tabsConfig[currentTabKey] : null;

                if (!currentTab) {
                    throw new Error('未找到该谱子的配置信息');
                }

                // 更新页面标题和谱子标题
                document.title = `${tabName} - 吉他谱详情 - 吉他谱网`;
                document.getElementById('tabTitle').textContent = `${tabName} - ${currentTab.singer}`;
                // 更新统计信息
                document.getElementById('singerSpan').innerHTML = `<i class="fas fa-user mr-1"></i> ${currentTab.singer}`;
                document.getElementById('typeSpan').innerHTML = `<i class="fas fa-guitar mr-1"></i> ${currentTab.type}谱`;
                document.getElementById('viewSpan').innerHTML = `<i class="fas fa-eye mr-1"></i> ${currentTab.view}次浏览`;
                document.getElementById('downloadSpan').innerHTML = `<i class="fas fa-download mr-1"></i> ${currentTab.download}次下载`;

                // 生成相关谱子推荐
                generateRelatedTabs(currentTabKey);
                // 准备自动滚动参数（确保存在数组）
                if (currentTab && !Array.isArray(currentTab.scroll)) currentTab.scroll = [{time:0, position:0}];
            } catch (error) {
                document.getElementById('tabTitle').textContent = '加载失败';
                document.getElementById('tabStats').innerHTML = `<span class="text-red-500">${error.message}</span>`;
                console.error('加载谱子配置失败：', error);
            }
        }

        // 2. 生成相关谱子推荐（排除当前谱子）
        function generateRelatedTabs(currentFolder) {
            const relatedTabs = document.getElementById('relatedTabs');
            // 取前3个非当前谱子的项作为推荐
            const otherTabs = Object.keys(tabsConfig).filter(folder => folder !== currentFolder).slice(0, 3);
            otherTabs.forEach(folderName => {
                const tab = tabsConfig[folderName];
                const relatedItem = document.createElement('div');
                relatedItem.className = 'bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow duration-300 cursor-pointer';
                relatedItem.onclick = () => {
                    window.location.href = `tab-detail.html?id=${tab.id}&name=${encodeURIComponent(folderName)}&folder=${encodeURIComponent(folderName)}`;
                };
                relatedItem.innerHTML = `
                    <h3 class="text-lg font-semibold mb-1">${folderName}</h3>
                    <p class="text-gray-500 text-sm mb-3">${tab.singer} | ${tab.type}谱</p>
                    <img src="${tab.cover}" alt="${folderName}吉他谱封面" class="w-full h-32 object-cover rounded-md">
                `;
                relatedTabs.appendChild(relatedItem);
            });
        }

        // 3. 动态加载谱子图片（原有逻辑不变）
        const tabContent = document.getElementById('tabContent');
        const loadingTip = document.getElementById('loadingTip');
        const maxPage = 5;

        function checkImageExists(url, callback) {
            const img = new Image();
            img.onload = () => callback(true);
            img.onerror = () => callback(false);
            img.src = url;
        }

        function loadTabImages() {
            let page = 1;
            loadingTip.textContent = '正在加载谱子图片...';

            function loadNextPage() {
                const imgUrl = `./source/${tabFolder}/${page}.png`;
                checkImageExists(imgUrl, (exists) => {
                    if (exists) {
                        const img = document.createElement('img');
                        img.src = imgUrl;
                        img.alt = `${tabName}吉他谱第${page}页`;
                        img.className = 'w-full max-w-3xl mx-auto rounded-md shadow-sm';
                        tabContent.appendChild(img);
                        page++;
                        loadNextPage();
                    } else {
                        loadingTip.remove();
                        if (page === 1) {
                            const emptyTip = document.createElement('p');
                            emptyTip.className = 'text-center text-red-500';
                            emptyTip.textContent = `未找到《${tabName}》的png格式谱子图片，请检查文件夹是否存在或图片命名是否正确！`;
                            tabContent.appendChild(emptyTip);
                        }
                    }
                });
            }
            loadNextPage();
        }

        // 4. 下载和打印功能（原有逻辑不变）
        document.getElementById('downloadBtn').addEventListener('click', () => {
            alert(`开始下载《${tabName}》的所有谱子图片！\n实际项目中可使用JSZip打包文件夹内的图片后下载`);
        });

        document.getElementById('printBtn').addEventListener('click', () => {
            window.print();
        });

        if (window.matchMedia) {
            const mediaQuery = window.matchMedia('print');
            mediaQuery.addEventListener('change', (e) => {
                if (e.matches) {
                    document.querySelector('header').style.display = 'none';
                    document.querySelector('footer').style.display = 'none';
                    document.querySelector('#relatedTabs').style.display = 'none';
                } else {
                    document.querySelector('header').style.display = 'block';
                    document.querySelector('footer').style.display = 'block';
                    document.querySelector('#relatedTabs').style.display = 'grid';
                }
            });
        }
        // ========== 新增：全屏查看逻辑 ==========
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const tabContentParent = tabContent.parentElement; // 谱子容器的父元素
        let isFullscreen = false; // 全屏状态标记
        let fullscreenContainer = null; // 全屏容器

        // 创建全屏容器并切换状态
        fullscreenBtn.addEventListener('click', () => {
            if (!isFullscreen) {
                // 进入全屏：创建全屏容器，复制谱子内容到其中
                fullscreenContainer = document.createElement('div');
                fullscreenContainer.className = 'tab-fullscreen';
                fullscreenContainer.style.overflow = 'auto';
                // 添加关闭按钮
                const closeBtn = document.createElement('button');
                closeBtn.className = 'fullscreen-close';
                closeBtn.innerHTML = '<i class="fas fa-times"></i>';
                closeBtn.onclick = () => toggleFullscreen(false);
                fullscreenContainer.appendChild(closeBtn);
                // 复制谱子内容（深拷贝，保留图片）
                fullscreenContainer.appendChild(tabContent.cloneNode(true));
                // 在全屏容器顶部加入一个自动滚动按钮副本，方便操作
                const fsControl = document.createElement('div');
                fsControl.style.position = 'absolute';
                fsControl.style.left = '16px';
                fsControl.style.top = '16px';
                fsControl.style.zIndex = '60';
                fsControl.innerHTML = `<button id="autoScrollBtn_fs" class="btn-action border border-primary text-primary hover:bg-primary/10"><i class="fas fa-play"></i><span class="hidden sm:inline">自动滚动</span></button>`;
                fullscreenContainer.appendChild(fsControl);
                // 添加到body
                document.body.appendChild(fullscreenContainer);
                // 禁止原页面滚动
                document.body.style.overflow = 'hidden';
                isFullscreen = true;
                // 按钮文字切换
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i><span class="hidden sm:inline">退出全屏</span>';
            } else {
                // 退出全屏
                toggleFullscreen(false);
            }
        });

        // 退出全屏的通用方法
        function toggleFullscreen(flag = true) {
            if (fullscreenContainer) {
                fullscreenContainer.remove();
                fullscreenContainer = null;
            }
            document.body.style.overflow = '';
            isFullscreen = false;
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i><span class="hidden sm:inline">全屏查看</span>';
            // exit fullscreen: ensure auto-scroll stopped
            stopAutoScrollOnExit();
        }

        // 按ESC键退出全屏
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isFullscreen) {
                toggleFullscreen(false);
            }
        });
        // ========== 新增：自动滚动逻辑 ==========
        const autoScrollBtn = document.getElementById('autoScrollBtn');
        let autoScrollState = {
            playing: false,
            rafId: null,
            startTime: 0,
            pausedAt: 0,
            steps: []
        };

        function getScrollTarget() {
            // 如果在全屏模式，滚动目标是全屏容器，否则滚动页面主区域（tabContent 的父容器）
            if (isFullscreen && fullscreenContainer) return fullscreenContainer;
            return document.scrollingElement || document.documentElement;
        }

        function prepareSteps() {
            const steps = (currentTab && Array.isArray(currentTab.scroll)) ? currentTab.scroll.slice() : [];
            // 确保至少有起点
            if (steps.length === 0) steps.push({time:0, position:0});
            // 按时间排序
            steps.sort((a,b) => a.time - b.time);
            autoScrollState.steps = steps;
        }

        function tick(now) {
            if (!autoScrollState.playing) return;
            if (!autoScrollState.startTime) autoScrollState.startTime = now - (autoScrollState.pausedAt || 0);
            const elapsed = (now - autoScrollState.startTime) / 1000; // seconds
            const steps = autoScrollState.steps;
            const target = getScrollTarget();
            if (!steps.length) return;

            // find current segment
            let i = 0;
            while (i < steps.length-1 && elapsed >= steps[i+1].time) i++;
            const s1 = steps[i];
            const s2 = (i < steps.length-1) ? steps[i+1] : null;
            let pos = s1.position;
            if (s2) {
                const dt = s2.time - s1.time;
                const t = dt === 0 ? 0 : (elapsed - s1.time) / dt;
                const clamped = Math.max(0, Math.min(1, t));
                pos = s1.position + (s2.position - s1.position) * clamped;
            } else {
                // after last step, keep at last position and stop
                pos = s1.position;
                // stop playback when elapsed exceeds last time + 1s buffer
                if (elapsed > s1.time + 1) {
                    stopAutoScroll();
                }
            }

            // apply position
            try {
                target.scrollTop = pos;
            } catch (e) {
                // fallback: window scroll
                window.scrollTo(0, pos);
            }

            autoScrollState.rafId = requestAnimationFrame(tick);
        }

        function startAutoScroll() {
            if (autoScrollState.playing) return;
            prepareSteps();
            autoScrollState.playing = true;
            autoScrollState.startTime = 0;
            autoScrollState.pausedAt = 0;
            // update UI icons
            updateAutoScrollButtons(true);
            autoScrollState.rafId = requestAnimationFrame(tick);
        }

        function stopAutoScroll() {
            autoScrollState.playing = false;
            if (autoScrollState.rafId) cancelAnimationFrame(autoScrollState.rafId);
            autoScrollState.rafId = null;
            autoScrollState.startTime = 0;
            autoScrollState.pausedAt = 0;
            updateAutoScrollButtons(false);
        }

        function toggleAutoScroll() {
            if (autoScrollState.playing) {
                stopAutoScroll();
            } else {
                startAutoScroll();
            }
        }

        function updateAutoScrollButtons(isPlaying) {
            const icons = document.querySelectorAll('#autoScrollBtn i, #autoScrollBtn_fs i');
            icons.forEach(ic => {
                ic.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
            });
        }

        // wire up main header button and future fullscreen copy
        autoScrollBtn.addEventListener('click', () => {
            prepareSteps();
            toggleAutoScroll();
        });

        // delegate clicks on potential fullscreen copy button
        document.addEventListener('click', (e) => {
            const fsBtn = e.target.closest('#autoScrollBtn_fs');
            if (fsBtn) {
                prepareSteps();
                toggleAutoScroll();
            }
        });

        // stop auto-scroll when exiting fullscreen
        function stopAutoScrollOnExit() {
            if (autoScrollState.playing) stopAutoScroll();
        }
        // ========== 全屏逻辑结束 ==========
        // 页面加载后执行
        window.addEventListener('DOMContentLoaded', async () => {
            await loadTabConfig(); // 先加载配置
            loadTabImages();      // 再加载图片
        });
    </script>
</body>
</html>